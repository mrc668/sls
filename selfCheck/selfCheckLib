# to be sourced into another file.
# http://www.fromtexttospeech.com/
# https://www.naturalreaders.com/online/
# one more: https://freetools.textmagic.com/text-to-speech

logger -p daemon.info -t selfCheck loading selfCheck Library
LOGGER="logger -p daemon.info -t $0"


function checkSSL {
  # host:port [ threshold ]
  [ "$2" ] && threshold=$2 || threshold=21
  testObject=$1
  echo $testObject | grep : -q || testObject="${testObject}:443"

  endDate=$(date -d "$(timeout 3 openssl s_client -connect $testObject 2>/dev/null < /dev/null| openssl x509 -enddate -noout 2>/dev/null | cut -d= -f2)" +%s )

  [ "$endDate" ] || {
    AllIsWell=1
    mpg123 /usr/local/mp3/{$testObject,isNotResponding}.mp3
    $LOGGER "$testObject is not responding."
    return
  }

  $LOGGER "$testObject certificate ends: " $(date -d @$endDate +%F)
  now=$(date +%s)

  if [ $endDate -gt $now ]
  then # cert has no expired

    daysTill=$(( ($endDate - $now) / 86400 ))
  
  
    [ $daysTill -lt $threshold ] && {
      AllIsWell=1
      mpg123 /usr/local/mp3/{certificate,$testObject,willExpireSoon}.mp3
      $LOGGER "certificate for $testObject will expire soon."
    } || {
      $LOGGER "certificate for $testObject is good for now."
    }

  else
    AllIsWell=1
    mpg123 /usr/local/mp3/{certificate,$testObject,hasExpired}.mp3
    $LOGGER "certificate for $testObject has expired."
  fi


} # checkSSL

function check_ethtool {
  dev=$1
  devSound=$(for i in $(echo $dev | fold -w1); do echo /usr/local/mp3/$i.mp3; done)
  EthToolOut=/dev/shm/ethtool.$dev
  /sbin/ethtool $dev > $EthToolOut

  grep Speed:.1000 $EthToolOut -q || {
    grep Speed:.1000 $EthToolOut | $LOGGER
    mpg123 $devSound /usr/local/mp3/{isnot,atGigSpeed}.mp3
    mpg123 $devSound /usr/local/mp3/{isnot,atGigSpeed}.mp3
	  AllIsWell=1
  }

  grep Duplex:.Full  $EthToolOut -q || {
    grep Duplex:.Full $EthToolOut | $LOGGER
    mpg123 $devSound /usr/local/mp3/isNotInDuplex.mp3
    mpg123 $devSound /usr/local/mp3/isNotInDuplex.mp3
	  AllIsWell=1
  }

  grep Link.detected:.yes  $EthToolOut -q || {
    grep Link.detected:.yes $EthToolOut | $LOGGER
    mpg123 $devSound /usr/local/mp3/hasNotDetectedLink.mp3
    mpg123 $devSound /usr/local/mp3/hasNotDetectedLink.mp3
	  AllIsWell=1
  }
}

function check_ping {
  remote=$1
  shift
  message="$*"

  log=$(mktemp /dev/shm/selfCheck-XXXXXX)

  /usr/lib64/nagios/plugins/check_fping $remote > $log 2>&1
  cat $log | $LOGGER
  grep OK $log -q || {
    mpg123 $message
    AllIsWell=1
  }
  rm -f $log
}

function check_dns {
  question=$1; shift
  server=$1; shift
  answer=$1; shift
  message="$*"

  log=$(mktemp /dev/shm/selfCheck-XXXXXX)

  echo "/usr/lib64/nagios/plugins/check_dns -H $question -s $server -q A -a $answer -w 5" | $LOGGER
  /usr/lib64/nagios/plugins/check_dns -H $question -s $server -q A -a $answer -w 5 > $log 2>&1
  cat $log | $LOGGER
  grep OK $log -q || {
    mpg123 $message
    AllIsWell=1
  }
  rm -f $log
}

